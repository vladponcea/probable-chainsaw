// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                String   @id @default(cuid())
  email             String?  @unique
  companyName       String?
  onboardingToken   String   @unique
  calendlyConnected Boolean  @default(false)
  closeConnected    Boolean  @default(false)
  stripeConnected   Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  integrations ClientIntegration[]
  bookedCalls  BookedCall[]
  leads        Lead[]
  deals        Deal[]
  payments     Payment[]
  statusMappings OpportunityStatusMapping[]
}

model ClientIntegration {
  id           String   @id @default(cuid())
  client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId     String
  provider     String   // "calendly" | "close" | "stripe" etc.
  accessToken  String?  // optional for OAuth-style
  refreshToken String?
  apiKey       String?  // for API-key style integrations
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([clientId, provider])
  @@unique([clientId, provider])
}

model BookedCall {
  id          String   @id @default(cuid())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    String
  externalId  String   // ID from Calendly or CRM
  source      String   // "calendly" | "crm"
  scheduledAt DateTime
  status      String   // "scheduled" | "completed" | "cancelled" | "no_show"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId, source])
  @@unique([clientId, externalId, source])
}

model Lead {
  id              String   @id @default(cuid())
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId        String
  externalId      String
  source          String   // "close" | "ghl" | "hubspot"
  firstName       String?
  lastName        String?
  email           String?
  status          String?  // pipeline stage
  firstContactDate DateTime? // when first email/call/SMS occurred
  dealId          String?
  deal            Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId, source])
  @@unique([clientId, externalId, source])
}

model Payment {
  id            String   @id @default(cuid())
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId      String
  externalId    String
  provider      String   // "stripe"
  amountCents   Int
  currency      String
  paidAt        DateTime
  status        String   // "succeeded" | "failed" | "refunded"
  subscriptionId String? // for tracking subscription payments
  isRecurring   Boolean  @default(false) // flag for subscription vs one-time
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([clientId, provider])
  @@unique([clientId, externalId, provider])
}

model Deal {
  id                 String   @id @default(cuid())
  client             Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId           String
  externalId         String
  source             String   // "close"
  name               String?
  amount             Float?   // deal value
  currency           String?  @default("USD")
  stage              String?  // pipeline stage
  status             String?  // "open" | "won" | "lost"
  createdAt          DateTime @default(now())
  lastStageChangeDate DateTime? // when deal last moved to a new stage
  updatedAt          DateTime @updatedAt
  leads              Lead[]

  @@index([clientId, source])
  @@index([clientId, stage])
  @@unique([clientId, externalId, source])
}

model OpportunityStatusMapping {
  id          String   @id @default(cuid())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId    String
  statusId    String   // Close CRM status ID
  statusLabel String   // Human-readable status name
  statusType  String?  // "active" | "won" | "lost" from Close
  showedUp    Boolean  @default(false) // Whether this status means they showed up
  isDefault   Boolean  @default(false) // Whether this was auto-assigned via smart defaults
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([clientId, statusId])
  @@index([clientId])
}

